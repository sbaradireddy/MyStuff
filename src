SQ_S10_NJ_DMV_MTHLY_EXTRACT as (
        SELECT row_number() over(order by NJ_DMV_UMIS_MTH_BUILD_ID) AS source_record_id,
               NJ_DMV_UMIS_MTH_BUILD_ID,
               POL_PK,
               POL_NUM,
               POL_SEQ_NUM,
               ORIG_POL_PK,
               POL_STATE_VRSN,
               POL_STATE_EFF_DT,
               ACCTG_DT,
               POL_STATE_STAT,
               ROW_XPTN_DT,
               POL_VRSN_TXN_TYP,
               ROW_STAT,
               RCD_ACTN_TYP_POL,
               DATA_DT,
               CORP_CD,
               CO_CD,
               SRC_PROD_ID,
               SRC_CD,
               SRC_POL_ID,
               CO_ID,
               PROD_ID,
               SRC_CORP_ID,
               SRC_CO_ID,
               PRCSG_GRP_CD,
               PROD_CD,
               CUR_TERM_EFF_DT,
               CUR_TERM_XPTN_DT,
               CNCL_RSN,
               CNCL_TYP,
               CNCL_EFF_DT,
               REINST_TYP,
               REINST_EFF_DT,
               REINST_RSN,
               LAPSE_BEGIN_DT,
               LAPSE_END_DT,
               PLN_CD,
               DMV_TRANS_TYPE,
               VEH_UNIT_PK,
               RCD_ACTN_TYP_VEH,
               ORGL_EFF_DT,
               VEH_TYP_CD,
               VIN,
               MODEL_YR,
               MK,
               STAT_MAKE_CD,
               ADDR_PK,
               PMRY_ADDR_FLG,
               HSE_NUM,
               ADDRESS1,
               ADDRESS2,
               ADDRESS3,
               ADDRESS4,
               CITY,
               STATE,
               CNTY,
               PSTL_CD,
               ZIP_FIRST5_CD,
               ZIP_LAST4_CD,
               INSD_PTY_PK_POL_OWNER,
               SRC_PTY_ID_POL_OWNER,
               NAM_FST_POL_OWNER,
               NAM_LST_POL_OWNER,
               NAM_MDL_POL_OWNER,
               NAM_SFX_POL_OWNER,
               BUS_NAM_POL_OWNER,
               PMRY_NAMD_INSD_FLG_POL_OWNER,
               NAMD_INSD_FLG_POL_OWNER,
               DRVR_FLG_POL_OWNER,
               DRVR_LIC_NUM_POL_OWNER,
               DRVR_LIC_STATE_POL_OWNER,
               ASSOCN_TYP_PRMRY_DRVR,
               INSD_PTY_PK_PRMRY_DRVR,
               SRC_PTY_ID_PRMRY_DRVR,
               NAM_FST_PRMRY_DRVR,
               NAM_LST_PRMRY_DRVR,
               NAM_MDL__PRMRY_DRVR,
               NAM_SFX_PRMRY_DRVR,
               NAMD_INSD_FLG_PRMRY_DRVR,
               DRVR_FLG_PRMRY_DRVR,
               DRVR_LIC_NUM_PRMRY_DRVR,
               DRVR_LIC_STATE__PRMRY_DRVR,
               BATCH_ID,
               CREATE_DT,
               CREATED_BY,
               BATCH_START_DT,
               BATCH_END_DT,
               RPRTG_PERIOD_START_DT,
               RPRTG_PERIOD_END_DT,
               DMV_VIN,
               DMV_DRIVER_LICENSE_NUMBER,
               DMV_MAKE_OF_CAR,
               DMV_YEAR_OF_CAR,
               DMV_MODEL_OF_CAR,
               DMV_INS_COMPANY_CD,
               DMV_POLICY_OWNER_STREET_ADDR,
               DMV_POLICY_OWNER_CITY,
               DMV_POLICY_OWNER_STATE,
               DMV_POLICY_OWNER_ZIP_CODE,
               DMV_TRANSACTION_TYPE_CODE,
               DMV_POLICY_EFFECTIVE_DATE,
               DMV_POLICY_CANCELLATION_DATE,
               DMV_DATE_STAMP,
               DMV_POLICY_NUMBER,
               DMV_RESERVED
          FROM S10_NJ_DMV_MTHLY_EXTRACT
       ) ,
EXPTRANS as (
        -- writting query for expression function
SELECT SQ_S10_NJ_DMV_MTHLY_EXTRACT.source_record_id,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NJ_DMV_UMIS_MTH_BUILD_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_PK,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_NUM,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_SEQ_NUM,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ORIG_POL_PK,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_STATE_VRSN,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_STATE_EFF_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ACCTG_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_STATE_STAT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ROW_XPTN_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_VRSN_TXN_TYP,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ROW_STAT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.RCD_ACTN_TYP_POL,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DATA_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CORP_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CO_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_PROD_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_POL_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CO_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.PROD_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_CORP_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_CO_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.PRCSG_GRP_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.PROD_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CUR_TERM_EFF_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CUR_TERM_XPTN_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CNCL_RSN,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CNCL_TYP,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CNCL_EFF_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.REINST_TYP,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.REINST_EFF_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.REINST_RSN,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.LAPSE_BEGIN_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.LAPSE_END_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.PLN_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_TRANS_TYPE,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.VEH_UNIT_PK,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.RCD_ACTN_TYP_VEH,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ORGL_EFF_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.VEH_TYP_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.VIN,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.MODEL_YR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.MK,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.STAT_MAKE_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ADDR_PK,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.PMRY_ADDR_FLG,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.HSE_NUM,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS1,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS2,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS3,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS4,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CITY,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.STATE,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CNTY,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.PSTL_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ZIP_FIRST5_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ZIP_LAST4_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.INSD_PTY_PK_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_PTY_ID_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_FST_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_LST_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_MDL_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_SFX_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.BUS_NAM_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.PMRY_NAMD_INSD_FLG_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAMD_INSD_FLG_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DRVR_FLG_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_NUM_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_STATE_POL_OWNER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.ASSOCN_TYP_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.INSD_PTY_PK_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_PTY_ID_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_FST_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_LST_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_MDL__PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAM_SFX_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.NAMD_INSD_FLG_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DRVR_FLG_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_NUM_PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_STATE__PRMRY_DRVR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.BATCH_ID,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CREATE_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.CREATED_BY,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.BATCH_START_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.BATCH_END_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.RPRTG_PERIOD_START_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.RPRTG_PERIOD_END_DT,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_VIN,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_DRIVER_LICENSE_NUMBER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_MAKE_OF_CAR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_YEAR_OF_CAR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_MODEL_OF_CAR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_INS_COMPANY_CD,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_STREET_ADDR,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_CITY,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_STATE,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_ZIP_CODE,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_TRANSACTION_TYPE_CODE,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_EFFECTIVE_DATE,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_CANCELLATION_DATE,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_DATE_STAMP,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_NUMBER,
               SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_RESERVED,
               LKP_ADD_VEH_DUPLICATES.POL_PK AS lkp_POL_PK,
               LKP_REINSTATE_WITH_LAPSE1.POL_PK AS LKP_REINSTATE_WITH_LAPSE1_lkp_POL_PK,
               LKP_CANCEL.POL_PK AS LKP_CANCEL_lkp_POL_PK
          FROM SQ_S10_NJ_DMV_MTHLY_EXTRACT SQ_S10_NJ_DMV_MTHLY_EXTRACT
          left join -- writting query for lookup function
 (
                select POL_PK,
                       POL_NUM,
                       DMV_TRANS_TYPE,
                       POL_STATE_EFF_DT,
                       DMV_VIN,
                       row_number() over(partition by POL_NUM, DMV_TRANS_TYPE, POL_STATE_EFF_DT, DMV_VIN order by POL_NUM, DMV_TRANS_TYPE, POL_STATE_EFF_DT, DMV_VIN) as rn -- Please review the order by columns

                  FROM S10_NJ_DMV_MTHLY_EXTRACT
                 where DMV_TRANS_TYPE = 'AV'
                 ORDER BY POL_STATE_EFF_DT --
qualify rn = 1
               ) LKP_ADD_VEH_DUPLICATES
            on LKP_ADD_VEH_DUPLICATES.POL_NUM=SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_NUM
           AND LKP_ADD_VEH_DUPLICATES.DMV_TRANS_TYPE=SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_TRANS_TYPE
           AND LKP_ADD_VEH_DUPLICATES.POL_STATE_EFF_DT<=SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_STATE_EFF_DT
           AND LKP_ADD_VEH_DUPLICATES.DMV_VIN=SQ_S10_NJ_DMV_MTHLY_EXTRACT.DMV_VIN
          left join -- writting query for lookup function
 (
                select POL_PK,
                       SRC_POL_ID,
                       POL_NUM,
                       POL_SEQ_NUM,
                       CO_CD,
                       CUR_TERM_EFF_DT,
                       row_number() over(partition by SRC_POL_ID, POL_PK, POL_NUM, POL_SEQ_NUM, CO_CD, CUR_TERM_EFF_DT order by SRC_POL_ID, POL_PK, POL_NUM, POL_SEQ_NUM, CO_CD, CUR_TERM_EFF_DT) as rn -- Please review the order by columns

                  FROM S10_NJ_DMV_MTHLY_EXTRACT
                 where SUBSTR(POL_VRSN_TXN_TYP,1,2) = 'CN'
                   AND CNCL_RSN IN ('NONPAY','NP','NP_CR','NP_PF')
                   AND ROW_STAT <> 'C' qualify rn = 1
               ) LKP_REINSTATE_WITH_LAPSE1
            on LKP_REINSTATE_WITH_LAPSE1.SRC_POL_ID=SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_POL_ID
           AND LKP_REINSTATE_WITH_LAPSE1.POL_PK<SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_PK
           AND LKP_REINSTATE_WITH_LAPSE1.POL_NUM=SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_NUM
           AND LKP_REINSTATE_WITH_LAPSE1.POL_SEQ_NUM=SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_SEQ_NUM
           AND LKP_REINSTATE_WITH_LAPSE1.CO_CD=SQ_S10_NJ_DMV_MTHLY_EXTRACT.CO_CD
           AND LKP_REINSTATE_WITH_LAPSE1.CUR_TERM_EFF_DT=SQ_S10_NJ_DMV_MTHLY_EXTRACT.CUR_TERM_EFF_DT
          left join -- writting query for lookup function
 (
                select POL_PK,
                       SRC_POL_ID,
                       POL_NUM,
                       POL_SEQ_NUM,
                       CO_CD,
                       CUR_TERM_EFF_DT,
                       row_number() over(partition by SRC_POL_ID, POL_PK, POL_NUM, POL_SEQ_NUM, CO_CD, CUR_TERM_EFF_DT order by SRC_POL_ID, POL_PK, POL_NUM, POL_SEQ_NUM, CO_CD, CUR_TERM_EFF_DT) as rn -- Please review the order by columns

                  FROM S10_NJ_DMV_MTHLY_EXTRACT
                 where SUBSTR(POL_VRSN_TXN_TYP,1,2) = 'RS'
                   AND REINST_TYP = 'WITH LAPSE'
                   AND CNCL_RSN IN ('NONPAY','NP','NP_CR','NP_PF') qualify rn = 1
               ) LKP_CANCEL
            on LKP_CANCEL.SRC_POL_ID=SQ_S10_NJ_DMV_MTHLY_EXTRACT.SRC_POL_ID
           AND LKP_CANCEL.POL_PK>SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_PK
           AND LKP_CANCEL.POL_NUM=SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_NUM
           AND LKP_CANCEL.POL_SEQ_NUM=SQ_S10_NJ_DMV_MTHLY_EXTRACT.POL_SEQ_NUM
           AND LKP_CANCEL.CO_CD=SQ_S10_NJ_DMV_MTHLY_EXTRACT.CO_CD
           AND LKP_CANCEL.CUR_TERM_EFF_DT=SQ_S10_NJ_DMV_MTHLY_EXTRACT.CUR_TERM_EFF_DT
       ) ,
EXPTRANS1 as (
        -- writting query for expression function
SELECT source_record_id,
               NJ_DMV_UMIS_MTH_BUILD_ID,
               POL_PK,
               POL_NUM,
               POL_SEQ_NUM,
               ORIG_POL_PK,
               POL_STATE_VRSN,
               POL_STATE_EFF_DT,
               ACCTG_DT,
               POL_STATE_STAT,
               ROW_XPTN_DT,
               POL_VRSN_TXN_TYP,
               ROW_STAT,
               RCD_ACTN_TYP_POL,
               DATA_DT,
               CORP_CD,
               CO_CD,
               SRC_PROD_ID,
               SRC_CD,
               SRC_POL_ID,
               CO_ID,
               PROD_ID,
               SRC_CORP_ID,
               SRC_CO_ID,
               PRCSG_GRP_CD,
               PROD_CD,
               CUR_TERM_EFF_DT,
               CUR_TERM_XPTN_DT,
               CNCL_RSN,
               CNCL_TYP,
               CNCL_EFF_DT,
               REINST_TYP,
               REINST_EFF_DT,
               REINST_RSN,
               LAPSE_BEGIN_DT,
               LAPSE_END_DT,
               PLN_CD,
               DMV_TRANS_TYPE,
               VEH_UNIT_PK,
               RCD_ACTN_TYP_VEH,
               ORGL_EFF_DT,
               VEH_TYP_CD,
               VIN,
               MODEL_YR,
               MK,
               STAT_MAKE_CD,
               ADDR_PK,
               PMRY_ADDR_FLG,
               HSE_NUM,
               ADDRESS1,
               ADDRESS2,
               ADDRESS3,
               ADDRESS4,
               CITY,
               STATE,
               CNTY,
               PSTL_CD,
               ZIP_FIRST5_CD,
               ZIP_LAST4_CD,
               INSD_PTY_PK_POL_OWNER,
               SRC_PTY_ID_POL_OWNER,
               NAM_FST_POL_OWNER,
               NAM_LST_POL_OWNER,
               NAM_MDL_POL_OWNER,
               NAM_SFX_POL_OWNER,
               BUS_NAM_POL_OWNER,
               PMRY_NAMD_INSD_FLG_POL_OWNER,
               NAMD_INSD_FLG_POL_OWNER,
               DRVR_FLG_POL_OWNER,
               DRVR_LIC_NUM_POL_OWNER,
               DRVR_LIC_STATE_POL_OWNER,
               ASSOCN_TYP_PRMRY_DRVR,
               INSD_PTY_PK_PRMRY_DRVR,
               SRC_PTY_ID_PRMRY_DRVR,
               NAM_FST_PRMRY_DRVR,
               NAM_LST_PRMRY_DRVR,
               NAM_MDL__PRMRY_DRVR,
               NAM_SFX_PRMRY_DRVR,
               NAMD_INSD_FLG_PRMRY_DRVR,
               DRVR_FLG_PRMRY_DRVR,
               DRVR_LIC_NUM_PRMRY_DRVR,
               DRVR_LIC_STATE__PRMRY_DRVR,
               BATCH_ID,
               CREATE_DT,
               CREATED_BY,
               BATCH_START_DT,
               BATCH_END_DT,
               RPRTG_PERIOD_START_DT,
               RPRTG_PERIOD_END_DT,
               DMV_VIN,
               DMV_DRIVER_LICENSE_NUMBER,
               DMV_MAKE_OF_CAR,
               DMV_YEAR_OF_CAR,
               DMV_MODEL_OF_CAR,
               DMV_INS_COMPANY_CD,
               DMV_POLICY_OWNER_STREET_ADDR,
               DMV_POLICY_OWNER_CITY,
               DMV_POLICY_OWNER_STATE,
               DMV_POLICY_OWNER_ZIP_CODE,
               DMV_TRANSACTION_TYPE_CODE,
               DMV_POLICY_EFFECTIVE_DATE,
               DMV_POLICY_CANCELLATION_DATE,
               DMV_DATE_STAMP,
               DMV_POLICY_NUMBER,
               DMV_RESERVED,
               LKP_CANCEL_lkp_POL_PK AS POL_PK_REINSTATED_WITH_LAPSE,
               LKP_REINSTATE_WITH_LAPSE1_lkp_POL_PK AS POL_PK_CANCEL,
               lkp_POL_PK AS POL_PK_ADD_VEH,
               (REGEXP_REPLACE(DMV_VIN,'[^a-z0-9A-Z]','')) AS o_DMV_VIN,
               IFF(DMV_TRANS_TYPE = 'NB' AND SUBSTR(POL_VRSN_TXN_TYP,1,2) != 'EN', 'N', IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'WITH LAPSE', 'N', IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT = 'C', 'N', IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT != 'C' AND POL_PK_REINSTATED_WITH_LAPSE > 0 AND POL_PK_REINSTATED_WITH_LAPSE > POL_PK, 'N', IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'REINSTATE' AND ROW_STAT = 'C' AND POL_PK_CANCEL IS NULL, 'N', IFF(DMV_TRANS_TYPE = 'AV' AND POL_PK = POL_PK_ADD_VEH, 'N', 'Y')))))) AS FILTER_OUT_IND
          FROM EXPTRANS
       ) ,
FILTRANS as (
        -- writing query for filter
 SELECT source_record_id,
               NJ_DMV_UMIS_MTH_BUILD_ID,
               FILTER_OUT_IND,
               POL_PK,
               POL_NUM,
               POL_SEQ_NUM,
               ORIG_POL_PK,
               POL_STATE_VRSN,
               POL_STATE_EFF_DT,
               ACCTG_DT,
               POL_STATE_STAT,
               ROW_XPTN_DT,
               POL_VRSN_TXN_TYP,
               ROW_STAT,
               RCD_ACTN_TYP_POL,
               DATA_DT,
               CORP_CD,
               CO_CD,
               SRC_PROD_ID,
               SRC_CD,
               SRC_POL_ID,
               CO_ID,
               PROD_ID,
               SRC_CORP_ID,
               SRC_CO_ID,
               PRCSG_GRP_CD,
               PROD_CD,
               CUR_TERM_EFF_DT,
               CUR_TERM_XPTN_DT,
               CNCL_RSN,
               CNCL_TYP,
               CNCL_EFF_DT,
               REINST_TYP,
               REINST_EFF_DT,
               REINST_RSN,
               LAPSE_BEGIN_DT,
               LAPSE_END_DT,
               PLN_CD,
               DMV_TRANS_TYPE,
               VEH_UNIT_PK,
               RCD_ACTN_TYP_VEH,
               ORGL_EFF_DT,
               VEH_TYP_CD,
               VIN,
               MODEL_YR,
               MK,
               STAT_MAKE_CD,
               ADDR_PK,
               PMRY_ADDR_FLG,
               HSE_NUM,
               ADDRESS1,
               ADDRESS2,
               ADDRESS3,
               ADDRESS4,
               CITY,
               STATE,
               CNTY,
               PSTL_CD,
               ZIP_FIRST5_CD,
               ZIP_LAST4_CD,
               INSD_PTY_PK_POL_OWNER,
               SRC_PTY_ID_POL_OWNER,
               NAM_FST_POL_OWNER,
               NAM_LST_POL_OWNER,
               NAM_MDL_POL_OWNER,
               NAM_SFX_POL_OWNER,
               BUS_NAM_POL_OWNER,
               PMRY_NAMD_INSD_FLG_POL_OWNER,
               NAMD_INSD_FLG_POL_OWNER,
               DRVR_FLG_POL_OWNER,
               DRVR_LIC_NUM_POL_OWNER,
               DRVR_LIC_STATE_POL_OWNER,
               ASSOCN_TYP_PRMRY_DRVR,
               INSD_PTY_PK_PRMRY_DRVR,
               SRC_PTY_ID_PRMRY_DRVR,
               NAM_FST_PRMRY_DRVR,
               NAM_LST_PRMRY_DRVR,
               NAM_MDL__PRMRY_DRVR,
               NAM_SFX_PRMRY_DRVR,
               NAMD_INSD_FLG_PRMRY_DRVR,
               DRVR_FLG_PRMRY_DRVR,
               DRVR_LIC_NUM_PRMRY_DRVR,
               DRVR_LIC_STATE__PRMRY_DRVR,
               BATCH_ID,
               CREATE_DT,
               CREATED_BY,
               BATCH_START_DT,
               BATCH_END_DT,
               RPRTG_PERIOD_START_DT,
               RPRTG_PERIOD_END_DT,
               o_DMV_VIN AS DMV_VIN,
               DMV_DRIVER_LICENSE_NUMBER,
               DMV_MAKE_OF_CAR,
               DMV_YEAR_OF_CAR,
               DMV_MODEL_OF_CAR,
               DMV_INS_COMPANY_CD,
               DMV_POLICY_OWNER_STREET_ADDR,
               DMV_POLICY_OWNER_CITY,
               DMV_POLICY_OWNER_STATE,
               DMV_POLICY_OWNER_ZIP_CODE,
               DMV_TRANSACTION_TYPE_CODE,
               DMV_POLICY_EFFECTIVE_DATE,
               DMV_POLICY_CANCELLATION_DATE,
               DMV_DATE_STAMP,
               DMV_POLICY_NUMBER,
               DMV_RESERVED
          FROM EXPTRANS1
         WHERE FILTER_OUT_IND = 'N' -- Note: Some Manual Workaround  Needed For This Type Of Conditions

       ) ,
UPDTRANS as (
        -- writting query for update strategy function
 SELECT FILTRANS.source_record_id,
               NJ_DMV_UMIS_MTH_BUILD_ID,
               POL_PK,
               POL_NUM,
               POL_SEQ_NUM,
               ORIG_POL_PK,
               POL_STATE_VRSN,
               POL_STATE_EFF_DT,
               ACCTG_DT,
               POL_STATE_STAT,
               ROW_XPTN_DT,
               POL_VRSN_TXN_TYP,
               ROW_STAT,
               RCD_ACTN_TYP_POL,
               DATA_DT,
               CORP_CD,
               CO_CD,
               SRC_PROD_ID,
               SRC_CD,
               SRC_POL_ID,
               CO_ID,
               PROD_ID,
               SRC_CORP_ID,
               SRC_CO_ID,
               PRCSG_GRP_CD,
               PROD_CD,
               CUR_TERM_EFF_DT,
               CUR_TERM_XPTN_DT,
               PLN_CD,
               DMV_TRANS_TYPE,
               VEH_UNIT_PK,
               RCD_ACTN_TYP_VEH,
               ORGL_EFF_DT,
               VEH_TYP_CD,
               VIN,
               MODEL_YR,
               MK,
               STAT_MAKE_CD,
               ADDR_PK,
               PMRY_ADDR_FLG,
               HSE_NUM,
               ADDRESS1,
               ADDRESS2,
               ADDRESS3,
               ADDRESS4,
               CITY,
               STATE,
               CNCL_RSN,
               CNCL_TYP,
               CNCL_EFF_DT,
               CNTY,
               PSTL_CD,
               ZIP_FIRST5_CD,
               ZIP_LAST4_CD,
               INSD_PTY_PK_POL_OWNER,
               SRC_PTY_ID_POL_OWNER,
               NAM_FST_POL_OWNER,
               NAM_LST_POL_OWNER,
               NAM_MDL_POL_OWNER,
               NAM_SFX_POL_OWNER,
               BUS_NAM_POL_OWNER,
               PMRY_NAMD_INSD_FLG_POL_OWNER,
               NAMD_INSD_FLG_POL_OWNER,
               DRVR_FLG_POL_OWNER,
               DRVR_LIC_NUM_POL_OWNER,
               DRVR_LIC_STATE_POL_OWNER,
               ASSOCN_TYP_PRMRY_DRVR,
               INSD_PTY_PK_PRMRY_DRVR,
               SRC_PTY_ID_PRMRY_DRVR,
               NAM_FST_PRMRY_DRVR,
               NAM_LST_PRMRY_DRVR,
               NAM_MDL__PRMRY_DRVR,
               NAM_SFX_PRMRY_DRVR,
               NAMD_INSD_FLG_PRMRY_DRVR,
               DRVR_FLG_PRMRY_DRVR,
               DRVR_LIC_NUM_PRMRY_DRVR,
               DRVR_LIC_STATE__PRMRY_DRVR,
               BATCH_ID,
               CREATE_DT,
               CREATED_BY,
               BATCH_START_DT,
               BATCH_END_DT,
               RPRTG_PERIOD_START_DT,
               RPRTG_PERIOD_END_DT,
               DMV_VIN,
               DMV_DRIVER_LICENSE_NUMBER,
               DMV_MAKE_OF_CAR,
               DMV_YEAR_OF_CAR,
               DMV_MODEL_OF_CAR,
               DMV_INS_COMPANY_CD,
               DMV_POLICY_OWNER_STREET_ADDR,
               DMV_POLICY_OWNER_CITY,
               DMV_POLICY_OWNER_STATE,
               DMV_POLICY_OWNER_ZIP_CODE,
               DMV_TRANSACTION_TYPE_CODE,
               DMV_POLICY_EFFECTIVE_DATE,
               DMV_POLICY_CANCELLATION_DATE,
               DMV_DATE_STAMP,
               DMV_POLICY_NUMBER,
               DMV_RESERVED,
               REINST_TYP,
               REINST_EFF_DT,
               REINST_RSN,
               LAPSE_BEGIN_DT,
               LAPSE_END_DT
          FROM FILTRANS
       ) ,

FINAL_SELECT_S20_NJ_DMV_MTHLY_BUILD AS(
        -- writing query for target definition
SELECT NJ_DMV_UMIS_MTH_BUILD_ID :: INTEGER AS NJ_DMV_UMIS_MTH_BUILD_ID,
               POL_PK :: INTEGER AS POL_PK,
               trim(POL_NUM) :: varchar(25) AS POL_NUM,
               POL_SEQ_NUM :: INTEGER AS POL_SEQ_NUM,
               ORIG_POL_PK :: INTEGER AS ORIG_POL_PK,
               POL_STATE_VRSN :: INTEGER AS POL_STATE_VRSN,
               POL_STATE_EFF_DT :: DATE AS POL_STATE_EFF_DT,
               ACCTG_DT :: DATE AS ACCTG_DT,
               trim(POL_STATE_STAT) :: varchar(10) AS POL_STATE_STAT,
               ROW_XPTN_DT :: DATE AS ROW_XPTN_DT,
               trim(POL_VRSN_TXN_TYP) :: varchar(3) AS POL_VRSN_TXN_TYP,
               trim(ROW_STAT) :: varchar(10) AS ROW_STAT,
               trim(RCD_ACTN_TYP_POL) :: varchar(1) AS RCD_ACTN_TYP_POL,
               DATA_DT :: DATE AS DATA_DT,
               trim(CORP_CD) :: varchar(10) AS CORP_CD,
               trim(CO_CD) :: varchar(10) AS CO_CD,
               SRC_PROD_ID :: INTEGER AS SRC_PROD_ID,
               trim(SRC_CD) :: varchar(10) AS SRC_CD,
               SRC_POL_ID :: INTEGER AS SRC_POL_ID,
               CO_ID :: INTEGER AS CO_ID,
               PROD_ID :: INTEGER AS PROD_ID,
               SRC_CORP_ID :: INTEGER AS SRC_CORP_ID,
               SRC_CO_ID :: INTEGER AS SRC_CO_ID,
               trim(PRCSG_GRP_CD) :: varchar(10) AS PRCSG_GRP_CD,
               trim(PROD_CD) :: varchar(10) AS PROD_CD,
               CUR_TERM_EFF_DT :: DATE AS CUR_TERM_EFF_DT,
               CUR_TERM_XPTN_DT :: DATE AS CUR_TERM_XPTN_DT,
               trim(CNCL_RSN) :: varchar(15) AS CNCL_RSN,
               trim(CNCL_TYP) :: varchar(2) AS CNCL_TYP,
               CNCL_EFF_DT :: DATE AS CNCL_EFF_DT,
               trim(REINST_TYP) :: varchar(10) AS REINST_TYP,
               REINST_EFF_DT :: DATE AS REINST_EFF_DT,
               trim(REINST_RSN) :: varchar(50) AS REINST_RSN,
               LAPSE_BEGIN_DT :: DATE AS LAPSE_BEGIN_DT,
               LAPSE_END_DT :: DATE AS LAPSE_END_DT,
               trim(PLN_CD) :: varchar(10) AS PLN_CD,
               trim(DMV_TRANS_TYPE) :: varchar(2) AS DMV_TRANS_TYPE,
               VEH_UNIT_PK :: INTEGER AS VEH_UNIT_PK,
               trim(RCD_ACTN_TYP_VEH) :: varchar(1) AS RCD_ACTN_TYP_VEH,
               ORGL_EFF_DT :: DATE AS ORGL_EFF_DT,
               trim(VEH_TYP_CD) :: varchar(10) AS VEH_TYP_CD,
               trim(VIN) :: varchar(30) AS VIN,
               MODEL_YR :: INTEGER AS MODEL_YR,
               trim(MK) :: varchar(25) AS MK,
               trim(STAT_MAKE_CD) :: varchar(20) AS STAT_MAKE_CD,
               ADDR_PK :: INTEGER AS ADDR_PK,
               trim(PMRY_ADDR_FLG) :: varchar(1) AS PMRY_ADDR_FLG,
               trim(HSE_NUM) :: varchar(10) AS HSE_NUM,
               trim(ADDRESS1) :: varchar(50) AS ADDRESS1,
               trim(ADDRESS2) :: varchar(50) AS ADDRESS2,
               trim(ADDRESS3) :: varchar(50) AS ADDRESS3,
               trim(ADDRESS4) :: varchar(50) AS ADDRESS4,
               trim(CITY) :: varchar(120) AS CITY,
               trim(STATE) :: varchar(2) AS STATE,
               trim(CNTY) :: varchar(60) AS CNTY,
               trim(PSTL_CD) :: varchar(13) AS PSTL_CD,
               trim(ZIP_FIRST5_CD) :: varchar(5) AS ZIP_FIRST5_CD,
               trim(ZIP_LAST4_CD) :: varchar(4) AS ZIP_LAST4_CD,
               INSD_PTY_PK_POL_OWNER :: INTEGER AS INSD_PTY_PK_POL_OWNER,
               SRC_PTY_ID_POL_OWNER :: INTEGER AS SRC_PTY_ID_POL_OWNER,
               trim(NAM_FST_POL_OWNER) :: varchar(40) AS NAM_FST_POL_OWNER,
               trim(NAM_LST_POL_OWNER) :: varchar(40) AS NAM_LST_POL_OWNER,
               trim(NAM_MDL_POL_OWNER) :: varchar(40) AS NAM_MDL_POL_OWNER,
               trim(NAM_SFX_POL_OWNER) :: varchar(10) AS NAM_SFX_POL_OWNER,
               trim(BUS_NAM_POL_OWNER) :: varchar(255) AS BUS_NAM_POL_OWNER,
               trim(PMRY_NAMD_INSD_FLG_POL_OWNER) :: varchar(1) AS PMRY_NAMD_INSD_FLG_POL_OWNER,
               trim(NAMD_INSD_FLG_POL_OWNER) :: varchar(1) AS NAMD_INSD_FLG_POL_OWNER,
               trim(DRVR_FLG_POL_OWNER) :: varchar(1) AS DRVR_FLG_POL_OWNER,
               trim(DRVR_LIC_NUM_POL_OWNER) :: varchar(25) AS DRVR_LIC_NUM_POL_OWNER,
               trim(DRVR_LIC_STATE_POL_OWNER) :: varchar(2) AS DRVR_LIC_STATE_POL_OWNER,
               trim(ASSOCN_TYP_PRMRY_DRVR) :: varchar(10) AS ASSOCN_TYP_PRMRY_DRVR,
               INSD_PTY_PK_PRMRY_DRVR :: INTEGER AS INSD_PTY_PK_PRMRY_DRVR,
               SRC_PTY_ID_PRMRY_DRVR :: INTEGER AS SRC_PTY_ID_PRMRY_DRVR,
               trim(NAM_FST_PRMRY_DRVR) :: varchar(40) AS NAM_FST_PRMRY_DRVR,
               trim(NAM_LST_PRMRY_DRVR) :: varchar(40) AS NAM_LST_PRMRY_DRVR,
               trim(NAM_MDL__PRMRY_DRVR) :: varchar(40) AS NAM_MDL__PRMRY_DRVR,
               trim(NAM_SFX_PRMRY_DRVR) :: varchar(10) AS NAM_SFX_PRMRY_DRVR,
               trim(NAMD_INSD_FLG_PRMRY_DRVR) :: varchar(1) AS NAMD_INSD_FLG_PRMRY_DRVR,
               trim(DRVR_FLG_PRMRY_DRVR) :: varchar(1) AS DRVR_FLG_PRMRY_DRVR,
               trim(DRVR_LIC_NUM_PRMRY_DRVR) :: varchar(25) AS DRVR_LIC_NUM_PRMRY_DRVR,
               trim(DRVR_LIC_STATE__PRMRY_DRVR) :: varchar(2) AS DRVR_LIC_STATE__PRMRY_DRVR,
               BATCH_ID :: INTEGER AS BATCH_ID,
               CREATE_DT :: DATE AS CREATE_DT,
               trim(CREATED_BY) :: varchar(55) AS CREATED_BY,
               BATCH_START_DT :: DATE AS BATCH_START_DT,
               BATCH_END_DT :: DATE AS BATCH_END_DT,
               RPRTG_PERIOD_START_DT :: DATE AS RPRTG_PERIOD_START_DT,
               RPRTG_PERIOD_END_DT :: DATE AS RPRTG_PERIOD_END_DT,
               trim(DMV_VIN) :: varchar(19) AS DMV_VIN,
               trim(DMV_DRIVER_LICENSE_NUMBER) :: varchar(15) AS DMV_DRIVER_LICENSE_NUMBER,
               trim(DMV_MAKE_OF_CAR) :: varchar(5) AS DMV_MAKE_OF_CAR,
               trim(DMV_YEAR_OF_CAR) :: varchar(4) AS DMV_YEAR_OF_CAR,
               trim(DMV_MODEL_OF_CAR) :: varchar(5) AS DMV_MODEL_OF_CAR,
               trim(DMV_INS_COMPANY_CD) :: varchar(4) AS DMV_INS_COMPANY_CD,
               trim(DMV_POLICY_OWNER_STREET_ADDR) :: varchar(30) AS DMV_POLICY_OWNER_STREET_ADDR,
               trim(DMV_POLICY_OWNER_CITY) :: varchar(20) AS DMV_POLICY_OWNER_CITY,
               trim(DMV_POLICY_OWNER_STATE) :: varchar(2) AS DMV_POLICY_OWNER_STATE,
               trim(DMV_POLICY_OWNER_ZIP_CODE) :: varchar(9) AS DMV_POLICY_OWNER_ZIP_CODE,
               trim(DMV_TRANSACTION_TYPE_CODE) :: varchar(1) AS DMV_TRANSACTION_TYPE_CODE,
               trim(DMV_POLICY_EFFECTIVE_DATE) :: varchar(8) AS DMV_POLICY_EFFECTIVE_DATE,
               trim(DMV_POLICY_CANCELLATION_DATE) :: varchar(8) AS DMV_POLICY_CANCELLATION_DATE,
               trim(DMV_DATE_STAMP) :: varchar(8) AS DMV_DATE_STAMP,
               trim(DMV_POLICY_NUMBER) :: varchar(30) AS DMV_POLICY_NUMBER,
               trim(DMV_RESERVED) :: varchar(32) AS DMV_RESERVED
          FROM UPDTRANS
       ) SELECT *
  FROM FINAL_SELECT_S20_NJ_DMV_MTHLY_BUILD;
