





-- Check LKP_ADD_VEH_DUPLICATES contribution
SELECT POL_PK, DMV_TRANS_TYPE, DMV_VIN, lkp_POL_PK
FROM S10_NJ_DMV_MTHLY_EXTRACT
LEFT JOIN LKP_ADD_VEH_DUPLICATES
ON S10_NJ_DMV_MTHLY_EXTRACT.POL_NUM = LKP_ADD_VEH_DUPLICATES.POL_NUM
   AND S10_NJ_DMV_MTHLY_EXTRACT.DMV_TRANS_TYPE = LKP_ADD_VEH_DUPLICATES.DMV_TRANS_TYPE
   AND S10_NJ_DMV_MTHLY_EXTRACT.DMV_VIN = LKP_ADD_VEH_DUPLICATES.DMV_VIN
WHERE LKP_ADD_VEH_DUPLICATES.lkp_POL_PK IS NOT NULL;

-- Check LKP_REINSTATE_WITH_LAPSE1 contribution
SELECT POL_PK, SRC_POL_ID, POL_NUM, LKP_REINSTATE_WITH_LAPSE1_lkp_POL_PK
FROM S10_NJ_DMV_MTHLY_EXTRACT
LEFT JOIN LKP_REINSTATE_WITH_LAPSE1
ON S10_NJ_DMV_MTHLY_EXTRACT.SRC_POL_ID = LKP_REINSTATE_WITH_LAPSE1.SRC_POL_ID
WHERE LKP_REINSTATE_WITH_LAPSE1.LKP_REINSTATE_WITH_LAPSE1_lkp_POL_PK IS NOT NULL;


-- Check LKP_CANCEL contribution
SELECT POL_PK, SRC_POL_ID, POL_NUM, LKP_CANCEL_lkp_POL_PK
FROM S10_NJ_DMV_MTHLY_EXTRACT
LEFT JOIN LKP_CANCEL
ON S10_NJ_DMV_MTHLY_EXTRACT.SRC_POL_ID = LKP_CANCEL.SRC_POL_ID
WHERE LKP_CANCEL.LKP_CANCEL_lkp_POL_PK IS NOT NULL;














-- Debug LKP_ADD_VEH_DUPLICATES
SELECT S10_NJ_DMV_MTHLY_EXTRACT.POL_PK, LKP_ADD_VEH_DUPLICATES.lkp_POL_PK, COUNT(*) AS record_count
FROM S10_NJ_DMV_MTHLY_EXTRACT
LEFT JOIN (
    SELECT POL_PK, DMV_TRANS_TYPE, POL_NUM, DMV_VIN, ROW_NUMBER() OVER (
        PARTITION BY POL_NUM, DMV_TRANS_TYPE, DMV_VIN 
        ORDER BY POL_NUM, DMV_TRANS_TYPE, DMV_VIN
    ) AS rn
    FROM S10_NJ_DMV_MTHLY_EXTRACT
    WHERE DMV_TRANS_TYPE = 'AV'
) LKP_ADD_VEH_DUPLICATES
ON S10_NJ_DMV_MTHLY_EXTRACT.POL_NUM = LKP_ADD_VEH_DUPLICATES.POL_NUM
   AND S10_NJ_DMV_MTHLY_EXTRACT.DMV_TRANS_TYPE = LKP_ADD_VEH_DUPLICATES.DMV_TRANS_TYPE
   AND S10_NJ_DMV_MTHLY_EXTRACT.DMV_VIN = LKP_ADD_VEH_DUPLICATES.DMV_VIN
WHERE LKP_ADD_VEH_DUPLICATES.rn = 1
GROUP BY S10_NJ_DMV_MTHLY_EXTRACT.POL_PK, LKP_ADD_VEH_DUPLICATES.lkp_POL_PK;
