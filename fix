
SELECT 
    POL_PK, 
    DMV_TRANS_TYPE, 
    ROW_STAT, 
    POL_VRSN_TXN_TYP, 
    REINST_TYP, 
    POL_PK_REINSTATED_WITH_LAPSE, 
    POL_PK_CANCEL, 
    POL_PK_ADD_VEH,
    CASE
        WHEN DMV_TRANS_TYPE = 'NB' 
             AND SUBSTR(POL_VRSN_TXN_TYP, 1, 2) != 'EN' THEN 'N'
        WHEN DMV_TRANS_TYPE = 'RS' 
             AND REINST_TYP = 'WITH LAPSE' THEN 'N'
        WHEN DMV_TRANS_TYPE = 'CN' 
             AND ROW_STAT = 'C' THEN 'N'
        WHEN DMV_TRANS_TYPE = 'CN' 
             AND ROW_STAT != 'C' 
             AND POL_PK_REINSTATED_WITH_LAPSE > 0 
             AND POL_PK_REINSTATED_WITH_LAPSE > POL_PK THEN 'N'
        WHEN DMV_TRANS_TYPE = 'RS' 
             AND REINST_TYP = 'REINSTATE' 
             AND ROW_STAT = 'C' 
             AND COALESCE(POL_PK_CANCEL, NULL) IS NULL THEN 'N'
        WHEN DMV_TRANS_TYPE = 'AV' 
             AND POL_PK = POL_PK_ADD_VEH THEN 'N'
        ELSE 'Y'
    END AS FILTER_OUT_IND
FROM EXP_PRE_FILTER;












IFF(DMV_TRANS_TYPE = 'NB' AND SUBSTR(POL_VRSN_TXN_TYP, 1, 2) != 'EN', 'N',
IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'WITH LAPSE', 'N',
IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT = 'C', 'N',
IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT != 'C' AND POL_PK_REINSTATED_WITH_LAPSE > 0 AND POL_PK_REINSTATED_WITH_LAPSE > POL_PK, 'N',
IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'REINSTATE' AND ROW_STAT = 'C' AND ISNULL(POL_PK_CANCEL), 'N',
IFF(DMV_TRANS_TYPE = 'AV' AND POL_PK = POL_PK_ADD_VEH, 'N',
'Y'))))))
