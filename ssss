
SELECT POL_PK, DMV_TRANS_TYPE, ROW_STAT, POL_VRSN_TXN_TYP, REINST_TYP,
       COALESCE(POL_PK_REINSTATED_WITH_LAPSE, 0) AS POL_PK_REINSTATED_WITH_LAPSE_CLEAN,
       COALESCE(POL_PK_CANCEL, 0) AS POL_PK_CANCEL_CLEAN,
       CASE
           WHEN DMV_TRANS_TYPE = 'NB' AND SUBSTR(POL_VRSN_TXN_TYP, 1, 2) != 'EN' THEN 'Condition1'
           WHEN DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'WITH LAPSE' THEN 'Condition2'
           WHEN DMV_TRANS_TYPE = 'CN' AND ROW_STAT = 'C' THEN 'Condition3'
           WHEN DMV_TRANS_TYPE = 'CN' AND ROW_STAT != 'C' 
                AND COALESCE(POL_PK_REINSTATED_WITH_LAPSE, 0) > 0 
                AND COALESCE(POL_PK_REINSTATED_WITH_LAPSE, 0) > POL_PK THEN 'Condition4'
           WHEN DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'REINSTATE' 
                AND ROW_STAT = 'C' 
                AND COALESCE(POL_PK_CANCEL, 0) = 0 THEN 'Condition5'
           WHEN DMV_TRANS_TYPE = 'AV' AND POL_PK = POL_PK_ADD_VEH THEN 'Condition6'
           ELSE 'Default'
       END AS MATCHED_CONDITION
FROM EXP_PRE_FILTER
WHERE POL_PK IN (83709650, 83499687, 83499688);

















SELECT 
    POL_PK, 
    DMV_TRANS_TYPE, 
    ROW_STAT, 
    POL_VRSN_TXN_TYP, 
    REINST_TYP, 
    COALESCE(POL_PK_REINSTATED_WITH_LAPSE, 0) AS POL_PK_REINSTATED_WITH_LAPSE_CLEAN, 
    COALESCE(POL_PK_CANCEL, 0) AS POL_PK_CANCEL_CLEAN, -- Handle NULLs
    POL_PK_ADD_VEH,
    CASE
        WHEN DMV_TRANS_TYPE = 'NB' 
             AND SUBSTR(POL_VRSN_TXN_TYP, 1, 2) != 'EN' THEN 'N'
        WHEN DMV_TRANS_TYPE = 'RS' 
             AND REINST_TYP = 'WITH LAPSE' THEN 'N'
        WHEN DMV_TRANS_TYPE = 'CN' 
             AND ROW_STAT = 'C' THEN 'N'
        WHEN DMV_TRANS_TYPE = 'CN' 
             AND ROW_STAT != 'C' 
             AND COALESCE(POL_PK_REINSTATED_WITH_LAPSE, 0) > 0 
             AND COALESCE(POL_PK_REINSTATED_WITH_LAPSE, 0) > POL_PK THEN 'N'
        WHEN DMV_TRANS_TYPE = 'RS' 
             AND REINST_TYP = 'REINSTATE' 
             AND ROW_STAT = 'C' 
             AND COALESCE(POL_PK_CANCEL, 0) = 0 THEN 'N' -- Handle NULL for POL_PK_CANCEL
        WHEN DMV_TRANS_TYPE = 'AV' 
             AND POL_PK = POL_PK_ADD_VEH THEN 'N' -- Keep this condition as is
        ELSE 'Y'
    END AS FILTER_OUT_IND
FROM EXP_PRE_FILTER;





















IFF(DMV_TRANS_TYPE = 'NB' AND SUBSTR(POL_VRSN_TXN_TYP,1,2) != 'EN', 'N', IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'WITH LAPSE', 'N', IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT = 'C', 'N', IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT != 'C' AND POL_PK_REINSTATED_WITH_LAPSE > 0 AND POL_PK_REINSTATED_WITH_LAPSE > POL_PK, 'N', IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'REINSTATE' AND ROW_STAT = 'C' AND POL_PK_CANCEL IS NULL, 'N', IFF(DMV_TRANS_TYPE = 'AV' AND POL_PK = POL_PK_ADD_VEH, 'N', 'Y')))))) AS FILTER_OUT_IND
          FROM EXP_PRE_FILTER

















IIF(DMV_TRANS_TYPE = 'NB' AND SUBSTR(POL_VRSN_TXN_TYP,1,2)  != 'EN', 'N',
IIF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'WITH LAPSE', 'N',
IIF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT = 'C', 'N',
IIF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT  != 'C' 
AND POL_PK_REINSTATED_WITH_LAPSE > 0 AND POL_PK_REINSTATED_WITH_LAPSE > POL_PK, 'N',
IIF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'REINSTATE' AND ROW_STAT =  'C'  AND ISNULL(POL_PK_CANCEL), 'N',
IIF(DMV_TRANS_TYPE = 'AV' AND POL_PK = POL_PK_ADD_VEH, 'N',
'Y'))))))
