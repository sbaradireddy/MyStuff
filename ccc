
EXPTRANS2 AS (
    -- Writing query for expression function
    SELECT 
        SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.source_record_id,
        SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.POL_PK,
        SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.CUR_TERM_EFF_DT,
        DATEADD(YEAR, -3, SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.CUR_TERM_EFF_DT) AS EARLIEST_LOSS_DATE,
        LKP_LOSS_HISTORY_COUNT.INCDT_COUNT
    FROM 
        SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT
    LEFT JOIN (
        -- Writing query for lookup function
        SELECT 
            V_POL_INCDT_DIM_HST.POL_PK AS POL_PK,
            COUNT(V_POL_INCDT_DIM_HST.INCDT_PK) AS INCDT_COUNT
        FROM 
            CDWQA.dwadmn.v_pol_incdt_dim_hst V_POL_INCDT_DIM_HST
        JOIN 
            CDWQA.dwadmn.v_pol_dim_hst_core VPDHC 
        ON 
            VPDHC.Pol_Pk = V_POL_INCDT_DIM_HST.Pol_Pk
        WHERE 
            V_POL_INCDT_DIM_HST.Prcsg_Grp_Cd = 'NE'
            AND V_POL_INCDT_DIM_HST.Co_Cd IN ('BHIC', 'BHICC', 'MWAC', 'PRAC', 'BHPIC', 'BHSIC', 'BHPFIC')
            AND V_POL_INCDT_DIM_HST.Prod_Cd IN ('DF', 'HO', 'PCAT')
            AND V_POL_INCDT_DIM_HST.Corp_Cd = 'PRC'
            AND V_POL_INCDT_DIM_HST.Rcd_Actn_Typ <> 'D'
            AND V_POL_INCDT_DIM_HST.Incdt_Typ_Cd = 'CLAIMS'
            AND V_POL_INCDT_DIM_HST.Clm_Loss_Typ_Cd NOT IN ('HAIL', 'MEDIC', 'QUAKE', 'SINK', 'WIND')
            AND V_POL_INCDT_DIM_HST.Clm_Net_Paid_Amt > 499.99
            AND V_POL_INCDT_DIM_HST.INCDT_DT < VPDHC.Cur_Term_Eff_Dt
            AND V_POL_INCDT_DIM_HST.INCDT_DT >= DATEADD(YEAR, -3, VPDHC.Cur_Term_Eff_Dt)
        GROUP BY 
            V_POL_INCDT_DIM_HST.POL_PK
        QUALIFY 
            ROW_NUMBER() OVER (PARTITION BY V_POL_INCDT_DIM_HST.POL_PK ORDER BY V_POL_INCDT_DIM_HST.POL_PK) = 1
    ) LKP_LOSS_HISTORY_COUNT
    ON LKP_LOSS_HISTORY_COUNT.POL_PK = SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.POL_PK
)













EXPTRANS2 as (
        -- writting query for expression function
SELECT SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.source_record_id,
               SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.POL_PK,
               SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.CUR_TERM_EFF_DT,
               DATEADD('YYYY', - 3, SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.CUR_TERM_EFF_DT) AS EARLIEST_LOSS_DATE,
               LKP_LOSS_HISTORY_COUNT.INCDT_COUNT
          FROM SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT
          left join -- writting query for lookup function
 (
                SELECT V_POL_INCDT_DIM_HST.POL_PK as POL_PK,
                       COUNT(V_POL_INCDT_DIM_HST.INCDT_PK) as INCDT_COUNT,
                       row_number() over(partition by V_POL_INCDT_DIM_HST.POL_PK order by V_POL_INCDT_DIM_HST.POL_PK) as rn -- Please review the order by columns

                  FROM CDWQA.dwadmn.v_pol_incdt_dim_hst V_POL_INCDT_DIM_HST ,
                       CDWQA.dwadmn.v_pol_dim_hst_core VPDHC 
                 WHERE V_POL_INCDT_DIM_HST.Prcsg_Grp_Cd='NE'
                   AND V_POL_INCDT_DIM_HST.Co_Cd IN ('BHIC', 'BHICC', 'MWAC', 'PRAC','BHPIC','BHSIC','BHPFIC')
                   AND V_POL_INCDT_DIM_HST.Prod_Cd IN ('DF', 'HO', 'PCAT')
                   AND V_POL_INCDT_DIM_HST.Corp_Cd='PRC'
                   AND V_POL_INCDT_DIM_HST.Rcd_Actn_Typ<>'D'
                   AND V_POL_INCDT_DIM_HST.Incdt_Typ_Cd='CLAIMS'
                   AND V_POL_INCDT_DIM_HST.Rcd_Actn_Typ<>'D'
                   AND V_POL_INCDT_DIM_HST.Clm_Loss_Typ_Cd NOT IN ('HAIL', 'MEDIC', 'QUAKE', 'SINK', 'WIND')
                   AND V_POL_INCDT_DIM_HST.Clm_Net_Paid_Amt > 499.99
                   AND V_POL_INCDT_DIM_HST.INCDT_DT < VPDHC.Cur_Term_Eff_Dt
                   AND V_POL_INCDT_DIM_HST.INCDT_DT >= (DATEADD(YEARS,-3,VPDHC.Cur_Term_Eff_Dt))
                   AND VPDHC.Pol_Pk=V_POL_INCDT_DIM_HST.Pol_Pk qualify rn = 1
                 GROUP BY V_POL_INCDT_DIM_HST.POL_PK
               ) LKP_LOSS_HISTORY_COUNT
            on LKP_LOSS_HISTORY_COUNT.POL_PK = SQ_S10_ISO_BURRPT_PLOTA_PREM_EXTRACT.POL_PK
       )
