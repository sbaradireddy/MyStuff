
SELECT 
    POL_PK,
    DMV_TRANS_TYPE,
    ROW_STAT,
    POL_VRSN_TXN_TYP,
    REINST_TYP,
    POL_PK_REINSTATED_WITH_LAPSE,
    POL_PK_CANCEL,
    POL_PK_ADD_VEH,
    IFF(DMV_TRANS_TYPE = 'NB' AND SUBSTR(POL_VRSN_TXN_TYP, 1, 2) != 'EN', 'N',
    IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'WITH LAPSE', 'N',
    IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT = 'C', 'N',
    IFF(DMV_TRANS_TYPE = 'CN' AND ROW_STAT != 'C' 
         AND POL_PK_REINSTATED_WITH_LAPSE > 0 
         AND POL_PK_REINSTATED_WITH_LAPSE > POL_PK, 'N',
    IFF(DMV_TRANS_TYPE = 'RS' AND REINST_TYP = 'REINSTATE' 
         AND ROW_STAT = 'C' 
         AND COALESCE(POL_PK_CANCEL, 0) = 0 
         AND NOT EXISTS (SELECT 1 FROM LKP_REINSTATE_WITH_LAPSE1 WHERE POL_PK = EXP_PRE_FILTER.POL_PK), 'N', -- Fix for extra RS records
    IFF(DMV_TRANS_TYPE = 'AV' AND POL_PK = POL_PK_ADD_VEH 
         AND EXISTS (SELECT 1 FROM LKP_ADD_VEH_DUPLICATES WHERE POL_PK = EXP_PRE_FILTER.POL_PK), 'N', -- Fix for extra AV records
    'Y')))))) AS FILTER_OUT_IND
FROM EXP_PRE_FILTER;








 -- WHEN DMV_TRANS_TYPE = 'RS' 
          --  AND REINST_TYP = 'REINSTATE' 
           -- AND ROW_STAT = 'C' 
           -- AND COALESCE(POL_PK_CANCEL, 0) = 0 THEN 'N' -- Handle NULL for POL_PK_CANCEL
       -- WHEN DMV_TRANS_TYPE = 'AV' 
             --AND POL_PK = POL_PK_ADD_VEH THEN 'N' -- Keep this condition as is
